\section{GZ model}
\subsection{Mathematical model}
The latent state transitions are
\begin{align*}
\xat &= \phia\xatt + \zat\bza + \errXa\;,\errXa\sim\NID{0}{\sigXa^2}\;,\\
\xbt &= \phib\xbtt + \zbt\bzb + \errXb\;,\errXb\sim\NID{0}{\sigXb^2}\;,\\
\xpt &= \phip\xptt + \zpt\bzp + \errXp\;,\errXp\sim\NID{0}{\sigXp^2}\;,\\
\xqt &= \phiq\xqtt + \zqt\bzq + \errXq\;,\errXq\sim\NID{0}{\sigXq^2}\;.
\end{align*}
The parameters of the state processes can be grouped as
\begin{align*}
\ts_a &=\left(\phia,\bza,\sigXa^2\right)\;,\\
\ts_b &=\left(\phib,\bzb,\sigXb^2\right)\;,\\
\ts_p &=\left(\phip,\bzp,\sigXp^2\right)\;,\\
\ts_q &=\left(\phiq,\bzq,\sigXq^2\right)\;.
\end{align*}
The measurement equation takes the general, highly nonlinear form, of
\begin{align*}
\nt=g\left(\exp\left(\xat\right),\exp\left(\xbt\right),\exp\left(\xpt\right),
\exp\left(\xqt\right)\right)\;.
\end{align*}
This implies $\forall~t=1,\ldots,T$ and $\forall~i=1,\ldots,N$
\begin{align*}
p_{\ts_a}\left(\xat|\xatt,\zat\right)
&=
\mathcal{N}\left(\xat~\given~\phia\xatt+\zat\bza,\sigXa^2\right)\;,\\
p_{\ts_b}\left(\xbt|\xbtt,\zbt\right)
&=
\mathcal{N}\left(\xbt~\given~\phib\xbtt+\zbt\bzb,\sigXb^2\right)\;,\\
p_{\ts_p}\left(\xpt|\xptt,\zpt\right)
&=
\mathcal{N}\left(\xpt~\given~\phip\xptt+\zpt\bzp,\sigXp^2\right)\;,\\
p_{\ts_q}\left(\xqt|\xqtt,\zqt\right)
&=
\mathcal{N}\left(\xqt~\given~\phiq\xqtt+\zqt\bzq,\sigXq^2\right)\;,\\
p
\left(
\nt\given 
\xat,\xbt,\xpt,\xqt
\right)&=
\mathcal{MNL}\left(\nt\given\pi_{it}^{(1)},\ldots,\pi_{it}^{(M_{it})}\right)\;,
\end{align*}
where $\pi_{it}^{(k)}=\left(F_{\text{GB2}}
\left(c_{it}^{(k)};\xat,\xbt,\xpt,\xqt\right)-F_{\text{GB2}}\left(c_{it}^{(k-1)};\xat,\xbt,\xpt,\xqt\right)\right)$. The income distribution function is a  four-parameter GB2:
\begin{align*}
F(c_{it}^{(k)};\xat,\xbt,\xpt,\xqt)
&=B(d_{t,i}^{(k)};\xpt,\xqt)
=
\frac{\int_{0}^{d_{t,i}^{(k)}} t^{\exp\left(\xpt\right)-1}(1-t)^{\exp\left(\xqt\right)-1}dt}
{\text{B}\left(\exp\left(\xpt\right),\exp\left(\xpt\right)\right)}\;,\\
d_{t,i}^{(k)} &=\frac{(c_{it}^{(k)}/\exp\left(\xbt\right))^{\exp\left(\xat\right)}}{1+(c_{it}^{(k)}/\exp\left(\xbt\right))^{\exp\left(\xat\right)}}\;.
\end{align*}
Finally, we need prior assumptions on $\left(\ts_a,\ts_b,\ts_p,\ts_q\right)$:
\begin{align*}
\sigXa^2 &\sim \IG{a_{x_a}}{b_{x_a}}\;,a_{x_a}=b_{x_a}=0.001\;,\\
\sigXb^2 &\sim \IG{a_{x_b}}{b_{x_b}}\;,a_{x_b}=b_{x_b}=0.001\;,\\
\sigXp^2 &\sim \IG{a_{x_p}}{b_{x_p}}\;,a_{x_p}=b_{x_p}=0.001\;,\\
\sigXq^2 &\sim \IG{a_{x_q}}{b_{x_q}}\;,a_{x_q}=b_{x_q}=0.001\;,\\
\left(\phia,\bza\right) &\sim \NID{0}{\I{a}}\;,\\
\left(\phib,\bzb\right) &\sim \NID{0}{\I{b}}\;,\\
\left(\phip,\bzp\right) &\sim \NID{0}{\I{p}}\;,\\
\left(\phiq,\bzq\right) &\sim \NID{0}{\I{q}}\;,
\end{align*}
where $\I{a},\I{b},\I{p},\I{q}$ are identity matrices of appropriate dimension. Alternatively, instead of $\I{a}$, one can model the variances of the parameters explicitly i.e. using $\sigma_{\bb_{\Z_a},\phia}^2\times\I{}$ with an additional (hierarchical) $\IG{}{}$-prior on $\sigma_{\bb_{\Z_a},\phia}^2$ (and similarly for $\I{b},\I{p},\I{q}$).\\
Let $\Xt$ be a generic state proces for some fixed $i=1,\ldots,N$ i.e. either $\bs{x}_{a,2:T},\bs{x}_{b,2:T},\bs{x}_{p,2:T}$ or $\bs{x}_{q,2:T}$. Note that the model can be written in matrix form as:
\begin{align*}
\Xt&=\Xtt\phi + \bs{z}_{2:T}\bz + \ErrX\;,\\
\Xt&=\Zt\times \left(\phi,\bz^{\prime}\right)^{\prime} + \ErrX\;,
\end{align*}
where $\Zt$ is a matrix containing as first column $\Xtt$ and the remaining $K$'regressors in $\bs{z}_{2:T}$.
This makes it easier to calculate the Gibbs block for $\phi$ in the next sections.
%
%
%
%
%
\clearpage
\subsection{Gibbs-Part: univariate (for one $i=1,\ldots,N$)}
We derive $p\left(\ts|x_{0:T},\bs{y}_{1:T}\right)$ for a particular $\xt\in\left\lbrace\xat,\xbt,\xpt,\xqt\right\rbrace$ i.e. fixing the cross sectional  unit $i$ and picking one of the four GB2 parameters. The full probabilistic model with $\bs{\theta}=\left(\sigma_X^2,\phi,\bz\right)$ can then be factorized according to
\begin{align*}
p\left(\ts,x_{0:T},\bs{y}_{1:T}\right)
&=
p\left(\bs{y}_{1:T}|\ts,x_{0:T}\right)p\left(x_{0:T},\ts\right)
=
\prodt p\left(\bs{y}_t|\xt,\ts\right)
\prodt p\left(\xt|\xtt,\ts\right)p\left(x_0|\ts\right)p\left(\ts\right)\;,\\
&=
\prodt \left(\bs{y}_t|\ts,x_{t}\right) \\
&\times
\frac{1}{\left(2\pi\sigma_{X}^2\right)^{T/2}}\prodt \exp \left(-\frac{\left(\xt-\phi\xtt-\zt\bz\right)^2}{2\sigma_X^2}\right)\\
&\times p\left(\ts\right)\;.
\end{align*}
Then, the conditional parameter distributions are conjugate and given as
\begin{align*}
p\left(\sigma_X^2|x_{0:T},\bs{y}_{1:T}\right)
&=\frac{1}{\left(2\pi\sigma_{X}^2\right)^{T/2}}\prodt \exp \left(-\frac{\left(\xt-\phi\xtt-\zt\bz\right)^2}{2\sigma_X^2}\right)\\
&\times \frac{b_X^{a_X}}{\Gamma\left(a_X\right)}\left(\sigma_X^2\right)^{-a_X-1}\exp\left(-\frac{b_X}{\sigma_X^2}\right)\\
\\
&\pt \left(\sigma_X^2\right)^{-(a_X+T/2)-1}
\times\exp
\left(
-\frac{1}{\sigma_X^2}
\left(
b_X+\frac{\sumt\left(\xt-\phi\xtt-\zt\bz\right)^2}{2}
\right)
\right)\;.
\end{align*}
With e.g. $a_X=b_X=0.001$, we have
\begin{align*}
\sigma_X^2\sim\IG{a^*_X}{b^*_X}\;,~a^*_X&=a_X+T/2\;,~b^*_X=b_X+\frac{\sumt\left(\xt-\phi\xtt-\zt\bz\right)^2}{2}\;.
\end{align*}
For $\bz^*=\left(\phi,\bz^{\prime}\right)^{\prime}$ with a normal prior $\bz^*\sim\mathcal{N}_{K+1}\left(\underline{\bz^*}, \Ozprior\right)$ and the previous $\Xt=\Zt\bz^* + \ErrX\;,$ we have
\begin{align*}
p\left(\bz^*\given \Xt,\Zt,\sigma_X^2\right) 
& \pt
\exp\left\lbrace-\frac{1}{2}\left(\Xt-\Zt\bz^*\right)^{\prime}\VCMt^{-1}\left(\Xt-\Zt\bz^*\right)\right\rbrace\\
& \times 
\exp\left\lbrace-\frac{1}{2}\left(\bz-\underline{\bz^*}\right)^{\prime}\Ozprior^{-1}\left(\bz-\underline{\bz^*}\right)\right\rbrace\\
\end{align*}
Because we have
\begin{align*}
\left(\Xt-\Zt\bz^*\right)^{\prime}\VCMt^{-1}\left(\Xt-\Zt\bz^*\right)
& =
\bz^{*\prime}\Zt^{\prime}\VCMt^{-1}\Zt\bz^{*}-2\bz^{*\prime}\Zt^{\prime}\VCMt^{-1}\Xt\\
& + \Xt^{\prime}\VCMt^{-1}\Xt
\\
\left(\bz^*-\underline{\bz^*}\right)^{\prime}\Ozprior^{-1}\left(\bz^*-\underline{\bz^*}\right) 
& = 
\bz^{*\prime}\Ozprior^{-1}\bz^*
-2\bz^{*\prime}\Ozprior^{-1}\underline{\bz^*}\\
& +
\underline{\bz^{*\prime}}*\Ozprior^{-1}\underline{\bz^*}
\end{align*}
we obtain
\begin{align*}
p\left(\bz^*\given \Xt,\Zt,\sigma_X^2\right)
&=
\mathcal{N}_{K+1}\left(\overline{\bz},\Ozpost\right)\;\\
\Ozpost
& =
\left[\Zt^{\prime}\VCMt^{-1}\Zt+\Ozprior^{-1}\right]^{-1} \\
\overline{\bz}
& =
\Ozpost\times\left[\Zt^{\prime}\VCMt^{-1}\Xt+\Ozprior^{-1}\bz\right]
\end{align*}
%
%
%
%
%
\clearpage
\underline{In Detail:}
%
%
%
%
%
\clearpage
\subsection{Gibbs-Part: multivariate (full cross section $\forall i=1,\ldots,N$)}
We now consider vector valued processes stacked along the cross sectional dimension as e.g. $\xtn,\ytn$. All the corresponding state transition and measurement equations factorize along the time dimension and given as
\begin{align*}
p_{\tsa}\left(\xatn|\xattn,\zatn\right)
&=
\mathcal{N}_{1:N}\left(\xatn~\given~\phi_a\xattn+\zatn\bza,\sigXa^2\I{N}\right)\;,\\
p_{\tsb}\left(\xbtn|\xbttn,\zbtn\right)
&=
\mathcal{N}_{1:N}\left(\xbtn~\given~\phi_b\xbttn+\zbtn\bzb,\sigXb^2\I{N}\right)\;,\\
p_{\tsp}\left(\xptn|\xpttn,\zptn\right)
&=
\mathcal{N}_{1:N}\left(\xptn~\given~\phi_p\xpttn+\zptn\bzp,\sigXp^2\I{N}\right)\;,\\
p_{\tsq}\left(\xqtn|\xqttn,\zqtn\right)
&=
\mathcal{N}_{1:N}\left(\xqtn~\given~\phi_q\xqttn+\zqtn\bzq,\sigXq^2\I{N}\right)\;,\\
p
\left(
\nt\given 
\xat,\xbt,\xpt,\xqt
\right)&=
\mathcal{MNL}\left(\nt\given\pi_{it}^{(1)},\ldots,\pi_{it}^{(M_{it})}\right)\;,
\end{align*}
with $\pi_{it}^{(k)}=\left(F_{\text{GB2}}
\left(c_{it}^{(k)};\xat,\xbt,\xpt,\xqt\right)-F_{\text{GB2}}\left(c_{it}^{(k-1)};\xat,\xbt,\xpt,\xqt\right)\right)$ and income distribution function as a four-parameter GB2
\begin{align*}
F(c_{it}^{(k)};\xat,\xbt,\xpt,\xqt)
&=B(d_{t,i}^{(k)};\xpt,\xqt)
=
\frac{\int_{0}^{d_{t,i}^{(k)}} t^{\exp\left(\xpt\right)-1}(1-t)^{\exp\left(\xqt\right)-1}dt}
{\text{B}\left(\exp\left(\xpt\right),\exp\left(\xpt\right)\right)}\;,\\
d_{t,i}^{(k)} &=\frac{(c_{it}^{(k)}/\exp\left(\xbt\right))^{\exp\left(\xat\right)}}{1+(c_{it}^{(k)}/\exp\left(\xbt\right))^{\exp\left(\xat\right)}}\;.
\end{align*}
However, as all state transitions share the same structure, we derive them for a particular $x_{t,1:N}\in \left\lbrace x_{a,t,1:N},x_{b,t,1:N},x_{p,t,1:N},x_{q,t,1:N}\right\rbrace$. Now, to obtain $p\left(\ts|x_\seqTN,\bs{y}_\seqTN\right)$, consider the full probabilistic model with $\bs{\theta}=\left(\sigma_X^2,\phi,\bz\right)$ as
\begin{align*}
p\left(\ts,x_\seqTN,\bs{y}_\seqTN\right)
&=
p\left(\bs{y}_\seqTN|\ts,x_\seqTN\right)p\left(x_\seqTN,\ts\right)\\
&=
\prodt p\left(\ytn|\xtn,\ts\right)
\prodt p\left(\xtn|\xttn,\ts\right)p\left(x_{0,1:N}|\ts\right)p\left(\ts\right)\;\\
&=
\prodt p\left(\ytn|\xtn\right)
\times
\prodt \frac{1}{\left(2\pi\right)^{N/2}\left(\det\left(\sigma_{X}^2\I{N}\right)\right)^{1/2}}\\
&\times
\prodt \exp \left(-\frac{1}{2\sigma_X^2}\left(\xtn-\phi\xttn-\ztn\bz\right)^{\prime}\left(\xtn-\phi\xttn-\ztn\bz\right)\right)\\
&\times p\left(\ts\right)\;\\
&=
\prodt p\left(\ytn|\xtn\right)\times
\left(2\pi\sigma_{X}^2\right)^{-NT/2}\\
&\times
\exp \left(-\frac{1}{2\sigma_X^2}\sumt\left(\xtn-\mux\right)^{\prime}\left(\xtn-\mux\right)\right)\\
&\times p\left(\ts\right)\;,~\mux=\phi\xttn+\ztn\bz\;.
\end{align*}
Then, the conditional parameter distributions are conjugate and given as
\begin{align*}
p\left(\sigma_X^2|x_{\seqTN}\right)
&=\left(2\pi\sigma_{X}^2\right)^{-NT/2}
\times
\exp \left(-\frac{1}{2\sigma_X^2}\sumt\left(\xtn-\mux\right)^{\prime}\left(\xtn-\mux\right)\right)\\
&\times \frac{\underline{b_X}^{\underline{a_X}}}{\Gamma\left(\underline{a_X}\right)}\left(\sigma_X^2\right)^{-\underline{a_X}-1}\exp\left(-\frac{\underline{b_X}}{\sigma_X^2}\right)\\
\\
&\pt \left(\sigma_X^2\right)^{-(\underline{a_X}+NT/2)-1}
\times\exp
\left(
-\frac{1}{\sigma_X^2}
\left(
\underline{b_X}+\frac{\sumt\left(\xtn-\mux\right)^{\prime}\left(\xtn-\mux\right)}{2}
\right)
\right)\;.
\end{align*}
With e.g. $\underline{a_X}=\underline{b_X}=0.001$, we have
\begin{align*}
\sigma_X^2|x_\seqTN\sim\IG{\overline{a_X}}{b^*_X}\;,~\overline{a_X}&=\underline{a_X}+NT/2\;,~\overline{b_X}=\underline{b_X}+\frac{\sumt\left(\xtn-\mux\right)^{\prime}\left(\xtn-\mux\right)}{2}\;.
\end{align*}
For $\bz^*=\left(\phi,\bz^{\prime}\right)^{\prime}$ with a normal prior $\bz^*\sim\mathcal{N}_{K+1}\left(\underline{\bz^*}, \Ozprior\right)$ and $\Xtn=\phi\Xttn+\ztn\bz + \ErrXn=\Ztn\bz^* + \ErrXn\;,$ we have
\begin{align*}
p\left(\bz^*\given x_\seqTN,\bs{Z}_\seqTN,\sigma_X^2\right) 
& \pt
\exp \left\lbrace-\frac{1}{2}\sumt\left(\xtn-\Ztn\bz^*\right)^{\prime}\VCMn^{-1}\left(\xtn-\Ztn\bz^*\right)\right\rbrace\\
& \times 
\exp\left\lbrace-\frac{1}{2}\left(\bz^*-\underline{\bz^*}\right)^{\prime}\Ozprior^{-1}\left(\bz^*-\underline{\bz^*}\right)\right\rbrace\;,
\end{align*}
which can as a whole expression be written as
\begin{align*}
\exp \left\lbrace
-\frac{1}{2}
\left[
\sumt
\left(
\xtn-\Ztn\bz^*\right)^{\prime}\VCMn^{-1}\left(\xtn-\Ztn\bz^*
\right)
+
\left(
\bz^*-\underline{\bz^*}\right)^{\prime}\Ozprior^{-1}\left(\bz^*-\underline{\bz^*}
\right)
\right]
\right\rbrace
\end{align*}
Because we have for every $t=1,\ldots,T$
\begin{align*}
\left(
\xtn-\Ztn\bz^*\right)^{\prime}\VCMn^{-1}\left(
\xtn-\Ztn\bz^*\right)
& =
\bz^{*\prime}\Ztn^{\prime}\VCMn^{-1}\Ztn\bz^{*}-2\bz^{*\prime}\Ztn^{\prime}\VCMn^{-1}\xtn\\
& + \xtn^{\prime}\VCMn^{-1}\xtn
\end{align*}
and prior
$
\left(\bz^*-\underline{\bz^*}\right)^{\prime}\Ozprior^{-1}\left(\bz^*-\underline{\bz^*}\right) 
= 
\bz^{*\prime}\Ozprior^{-1}\bz^*
-2\bz^{*\prime}\Ozprior^{-1}\underline{\bz^*} +
\underline{\bz^{*\prime}}*\Ozprior^{-1}\underline{\bz^*}
$
we obtain
\begin{align*}
p\left(\bz^*\given x_\seqTN,\bs{Z}_\seqTN,\sigma_X^2\right) 
&=
\mathcal{N}_{K+1}\left(\overline{\bz},\Ozpost\right)\;\\
\Ozpost
& =
\left[\sumt\Ztn^{\prime}\VCMn^{-1}\Ztn+\Ozprior^{-1}\right]^{-1} \\
\overline{\bz}
& =
\Ozpost\times\left[\sumt\Ztn^{\prime}\VCMn^{-1}\xtn+\Ozprior^{-1}\bz\right]
\end{align*}
%
%
%
%
%
\clearpage
\underline{In Detail:}
%
%
%
%
%
\clearpage
\underline{In Detail:}